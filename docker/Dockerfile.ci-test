FROM python:3.13-slim

# Install system dependencies (same as CI)
RUN apt-get update && apt-get install -y \
    ffmpeg \
    mediainfo \
    libsndfile1 \
    libopencv-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy project files
COPY . .

# Make verification script executable
RUN chmod +x scripts/verify_container_components.py

# Install Python dependencies (same as CI)
RUN python -m pip install --upgrade pip && \
    pip install -e .[dev]

# Create test directories (same as CI)
RUN mkdir -p /tmp/music/source /tmp/music/temp /tmp/music/metadata /tmp/music/screenshots && \
    echo "üìÅ Available test files:" && \
    ls -la tests/files/ && \
    echo "üìã Copying test files..." && \
    find tests/files/ -name "*.mp4" -exec cp {} /tmp/music/source/ \; && \
    find tests/files/ -name "*.jpeg" -exec cp {} /tmp/music/source/ \; && \
    find tests/files/ -name "*.flac" -exec cp {} /tmp/music/source/ \; && \
    find tests/files/ -name "*.mp3" -exec cp {} /tmp/music/source/ \; && \
    echo "‚úÖ Test files copied:" && \
    ls -la /tmp/music/source/ && \
    echo "üìä Total files: $(ls /tmp/music/source/ | wc -l)"

# Copy and setup test script
RUN chmod +x scripts/run_ci_tests.sh

# Default command runs all CI tests using our script  
CMD ["./scripts/run_ci_tests.sh"]