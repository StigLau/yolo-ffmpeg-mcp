FROM python:3.13-slim

# Install system dependencies (same as CI)
RUN apt-get update && apt-get install -y \
    ffmpeg \
    mediainfo \
    libsndfile1 \
    libopencv-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy project files
COPY . .

# Install Python dependencies (same as CI)
RUN python -m pip install --upgrade pip && \
    pip install -e .[dev]

# Create test directories (same as CI)
RUN mkdir -p /tmp/music/{source,temp,metadata,screenshots} && \
    ls -la tests/files/ && \
    cp tests/files/*.mp4 /tmp/music/source/ 2>/dev/null || echo "No MP4 files found" && \
    cp tests/files/*.jpeg /tmp/music/source/ 2>/dev/null || echo "No JPEG files found" && \
    cp tests/files/*.flac /tmp/music/source/ 2>/dev/null || echo "No FLAC files found" && \
    cp tests/files/*.mp3 /tmp/music/source/ 2>/dev/null || echo "No MP3 files found" && \
    ls -la /tmp/music/source/

# Copy and setup test script
RUN chmod +x scripts/run_ci_tests.sh

# Default command runs all CI tests using our script  
CMD ["./scripts/run_ci_tests.sh"]